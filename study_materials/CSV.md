# Сериализация и Десереализация.

> `Сериализация` — процесс преобразования объекта в поток байтов для сохранения или передачи в память, базу данных или файл. Эта операция предназначена для того, чтобы сохранить состояния объекта для последующего воссоздания при необходимости. Обратный процесс называется десериализацией.

# CSV файлы.

### CSV - Сomma Separated Values ( пер. "Значения разделенные запятыми" )

`CSV файлы`
* распространенный формат файлов для представления табличных данных.
* активно используются для передачи информации между различными источниками данных. Например мы можем прочитать данные из таблицы **Excel**, а затем обработать и передать в **БД** или отразить информацию на сайте.
* Простой фармат не требует для работы специальных программ или сложных библиотек. 

**Ниже рассмотрим основные моменты работы с файлами формата CSV:**

Десериализация в список:

* reader = csv.reader(file)
* data = list(reader)
    
Десериализация в словарь:

* reader = csv.DictReader(file)
    
Сериализация:

* writer = csv.writer(file)
* writer.writerows(data)
* writer.writerow(data)
    
Настройки форматирования:

* csv.register_dialect()

## Чтение данных из CSV файла в список. Функция reader()

> Функция `reader()` производит построчное чтение файла, что оптимально при работе с большими файлами поскольку не требует единовременной загрузки всех данных в оперативную память.

Содержание файла `works.txt`:

```
Alex S,Developer,Python
Oksana S,CG_Artist,Photoshop
```

Воспользуемся функцией `reader()` из библиотеки `csv`:

```python
import csv

with open('works.txt') as f:
    works = csv.reader(f)
    for work in works:
        print(work)
```

_В результате каждая строка будет представлена ввиде списка, а данные строки, разделенные запятыми, будут отдельными элементами этого списка:_
```
['Alex S', 'Developer', 'Python']
['Oksana S', 'CG_Artist', 'Photoshop']
```

### Разделитель строки и параметр delimiter

> Деление данных строки на элементы списка происходит при помощи разделителя, по умолчанию принято использопять запятую ","

Используем в файле `works.txt` в качестве разделителя точку с запятой:

```
Alex S;Developer;Python
Oksana S;CG_Artist;Photoshop
```

**Запустим код:**

```python
import csv

with open('works.txt') as f:
    works = csv.reader(f)
    for work in works:
        print(work)
```

В результате каждая строка будет преобразована в список состоящий из одного элемента, что нам не подходит:
```
['Alex S;Developer;Python']
['Oksana S;CG_Artist;Photoshop']
```

Используем параметр `delimiter` и укажем `точку с запятой` в качестве разделителя данных строки:

Текущее содержание файла `works.txt`:
```
Alex S;Developer;Python
Oksana S;CG_Artist;Photoshop
```

**Запустим код:**

```python
import csv

with open('works.txt') as f:
    works = csv.reader(f, delimiter=';')
    for work in works:
        print(work)
```

_Получаем правильный вывод данных:_
```
['Alex S', 'Developer', 'Python']
['Oksana S', 'CG_Artist', 'Photoshop']
```

###  Обрамление данных в двойные кавычки и параметр quotechar:

>По умлолчанию `Python` воспринимает данные обрамленные `в двойные кавычки` в файлах `CSV` как `единый объект`. Это может быть полезным для избежания конфликта и корректной обработки данных, когда символ разделителя, например запятая, так же пресутсвует в тексте, который мы обрабатываем.

Возьмем в двойные кавычки первую строку. Текущее содержание файла `works.txt`:
```
"Alex S,Developer,Python"
Oksana S,CG_Artist,Photoshop
```

**Запустим код:**
```python
import csv

with open('works.txt') as f:
    works = csv.reader(f)
    for work in works:
        print(work)
```

*В результате первая строка файла будет преобразована в список из одного элемента, включаещего все данные строки:*
```
['Alex S,Developer,Python']
['Oksana S', 'CG_Artist', 'Photoshop']
```

Применим параметр `quotechar`, который позволяет нам установить символ указывающий на, то что данные строки, обрамленные в указанный, символ должны восприниматься как единый элемент:

**Текущее содержание файла** `works.txt`:
```
"Alex S,Developer,Python"
Oksana S,CG_Artist,Photoshop
```

**Выполним код:**
```python
import csv

with open('works.txt') as f:
    works = csv.reader(f, quotechar="'")
    for work in works:
        print(work)
```

*В результате* `Python` проигнорировал двойные кавычки, так как теперь они не являются символом объединяющим данные строки в единый объект по умолчанию, и разбил строку на отдельные элементы списка.

```Следует отметить что двойные кавычки при этот остались на месте и стали частью элемента списка.```
```
['"Alex S', 'Developer', 'Python"']
['Oksana S', 'CG_Artist', 'Photoshop']
```

### Чтение всего содержимого файла в список

>Помимо построчного чтения файла, возможно сразу прочитать все его содержимое и представить данные ввиде списка. Такой способ может не подойти для работы с большими объемами файлов, так как объема ОЗУ может не хватить для хранения всех данных.

**Текущее содержание файла** `works.txt`:
```
name,prof,tool
Alex S,Developer,Python
Oksana S,CG_Artist,Photoshop
```

**Выполним код:**
```python
import csv

with open('works.txt') as open_file:
    work_file = csv.reader(open_file)
    work_list = list(work_file)
    
    #Сравним два выода:
    print(work_file)
    print(work_list)
```

_Результаты вывода на экран:_
```
<_csv.reader object at 0x0000026A6AB76CE0>

[['name', 'prof', 'tool'], ['Alex S', 'Developer', 'Python'], ['Oksana S', 'CG_Artist', 'Photoshop']]
```

## Чтение данных из CSV файла в словарь. Функция DictReader()

> Для чтения данных из `CSV` файла в `словарь` нам `необходимо` в первою строку файла `добавить ключи` для будущего словаря:

**Текущее содержание файла после добавления ключей** `works.txt`:
```
name,prof,tool
Alex S,Developer,Python
Oksana S,CG_Artist,Photoshop
```

**Выполним код**:
```python
import csv

with open('works.txt') as f:
    works = csv.DictReader(f)
    for work in works:
        print(work)
```

_В результате получаем `словарь` с указанными ключами:_
```
{'name': 'Alex S', 'prof': 'Developer', 'tool': 'Python'}
{'name': 'Oksana S', 'prof': 'CG_Artist', 'tool': 'Photoshop'}
```

## Запись в CSV файл из списка. Функция writer() 

### csv.register_dialect() - настройки форматирования записи:

Настройки форматирования можно производить через создание шаблона `csv.register_dialect()` или передав в функцию `reader()` напрямую:
* **delimiter=""** - позволяет установить разделитель, по умолчанию запятая.
* **quotechar=""** - позволяет задать символ обрамления данных, по умолчанию двойные кавычки.
* **quoting=**
    * `quoting=csv.QUOTE_MINIMAL` - минимальное использование кавычек, только там где необходимо. (по умалчанию)
    * `quoting=csv.QUOTE_ALL` - все объекты данных обрамляются кавычками.
    * `quoting=csv.QUOTE_NONNUMERIC` - запрещает использование кавычек для обособления данных.
    * `quoting=csv.QUOTE_NONE` - кавычки запрещены.
* `escapechar="\\"` - Данный параметр актуален, если мы зарпещаем использование кавычек через `quoting.csv.QUOTQ_NONE`. Проблемные символы принято прятать за обратным слешем, поскольку это служебный символ, его необходимо экранировать, поэтому обратных слешей будет два. 

### writer() writerow() writerows()

>Функция `writer()` так же может тиспользовать дополнительные параметры `delimiter=` и `quotechar=`

> Функция `writerow()` производит запись списка в файл в виде одно строки, где элементы списка разделены разделителем.

> Функция `writerows()` производит построчную запись в файл данных списка, елементами которого являются другие списки, каждый список записывается отдельно строкой, а элементы вложенных списков разделены разделителем.

**Выполним код:**
```python
import csv

with open('new.txt', 'w') as open_file:
    work_file = csv.writer(open_file)
    work_file.writerow(['Alex S', 'Developer', 'Python'])
    work_file.writerow(['Oksana S', 'CG_Artist', 'Photoshop'])
```

*В результате будет создан файл `new.txt` и произойдет запись данных:*
```    
Alex S,Developer,Python

Oksana S,CG_Artist,Photoshop
```

> Обращаем внимание что функция `writerow()` всегда будет добавлять пустую строку между записываемыми строками наших данных. Чтобы этого избежать воспользуемся дополнительным параметром `newline=` в функции `writer()`

**Выполним код:**
```python
import csv

with open('new.txt', 'w', newline='') as open_file:
    work_file = csv.writer(open_file)
    work_file.writerow(['Alex S', 'Developer', 'Python'])
    work_file.writerow(['Oksana S', 'CG_Artist', 'Photoshop'])
```

Получим результат в файле `new.txt`:
```
Alex S,Developer,Python
Oksana S,CG_Artist,Photoshop
```

## Примеры:

### - Примеры. Блок 1. (Чтение файла и запись его данных в новый файл.)

**Исходный файл `reader.txt`:**
```
Заголовок,первая строка
Вторая строка,текст,цифры
Третья строка,текст,цифры
Четвертая строка,текст,цифры
Пятая строка,текст,цифры
Последняя строка,не выводится
```

**Выполним код:**
```python
import csv
from pprint import pprint

with open('reader.txt') as open_file:
    read_file = csv.reader(open_file)
    for row in read_file:
        print(row)

# Открытие и чтение файла в список:
    # Возвращаем курсор в начало файла при помощи seek() для повторного прочтения:
    open_file.seek(0)
    read_file = csv.reader(open_file)
    
    # Представляем данные файла в виде списка списков:
    work_list = list(read_file)
    pprint(work_list)
    
    # Помещаем Заголовок в переменную:
    title = work_list[0]

# Открываем новый файл для записи данных:
with open('writer.txt', 'w', newline='') as new_file:
    write_file = csv.writer(new_file)
    
    # Произведем запись в файл используя функции:
    write_file.writerow(title)
    write_file.writerows(work_list[1:5])
```

*Результат записи в файл `writer.txt`:*
```
Заголовок,первая строка
Вторая строка,текст,цифры
Третья строка,текст,цифры
Четвертая строка,текст,цифры
Пятая строка,текст,цифры
```

### - Примеры. Блок 2. (Чтение файла с дополнительными параметрами.)

**Исходный файл `reader.txt`:**
```
Заголовок;первая строка
Вторая строка;"текст;цифры"
'Третья строка;текст;цифры'

```

**Выполним код с параметрами `reader()` по умолчанию:**
```python
import csv

with open('reader.txt') as open_file:
    read_file = csv.reader(open_file)
    for row in read_file:
        print(row)
```

*Получим результат:* 
```
['Заголовок;первая строка']
['Вторая строка;"текст;цифры"']
["'Третья строка;текст;цифры'"]
```
- *Все строки преобразованы в единый элемент списка, так как в файле в качестве разделителя была указана точка с запятой, а параметр по умолчанию запятая, разделения строки на отдельные элементы списка не произошло.*
- *Во второй строке присутсвовали двойные кавычки, но поскольку разделения строки на элементы списка не произошло, Python эту ситуацию никак не обработал, так как в этой ситуации двойные кавычки восприняты как символ входящий в объект.*
- *Третья строка содержит одинарные кавычки, поэтому при преобразовании строки в элемент списка Python пришлось применить двойные кавычки для выделение элемента списка.*

### пример использования `delimiter=`

**Исходный файл `reader.txt` без имзменений:**
```
Заголовок;первая строка
Вторая строка;"текст;цифры"
'Третья строка;текст;цифры'
```

**Выполним код c дополнительным параметром `delimiter=` для функции `reader()`:**
```python
import csv

with open('reader.txt') as open_file:
    # Укажем в качестве разделителя точку с запятой, вместо запятой по умолчанию.
    read_file = csv.reader(open_file, delimiter=';') 
    for row in read_file:
        print(row)
```

*Получим результат:* 
```
['Заголовок', 'первая строка']
['Вторая строка', 'текст;цифры']
["'Третья строка", 'текст', "цифры'"]
```
- *Строки разделены на отдельные элементы списка.*
- *Так же Python отработал двойные кавычки во второй строке и по умолчанию выделил их содержимое в отдельный элемент списка, проигнорировав разделитель в виде двойных кавычек.*
- *Одинарные кавычки в третье строке в данной интерпретации являются символом входящим в состав отдельных элементов списка.*

### пример использования `quotechar=`

**Исходный файл `reader.txt` без имзменений:**
```
Заголовок;первая строка
Вторая строка;"текст;цифры"
'Третья строка;текст;цифры'
```

**Введем еще один дополнительный параметр `quotechar=` для функции `reader()`:**
```python
import csv

with open('reader.txt') as open_file:
    # Укажем в качестве символа обособления одинарные кавычки, вместо двойных по умолчанию.
    read_file = csv.reader(open_file, delimiter=';', quotechar="'") 
    for row in read_file:
        print(row)
```

_Получим результат:_
```
['Заголовок', 'первая строка']
['Вторая строка', '"текст', 'цифры"']
['Третья строка;текст;цифры']
```

- *На этот раз обособление в единый элемент списка произолшо с учетом одинарных кавычек в третьей строке.*
- *Вторая строка разбилась на отдельные элементы списка, а двойные кавычки теперь являются частью этих элементов.*

### пример использования `quoting=`

**Исходный файл `reader.txt` без имзменений:**
```
Заголовок;первая строка
Вторая строка;"текст;цифры"
'Третья строка;текст;цифры'
```

**Введем дополнительный параметр `quoting=` для функции `reader()`:**

```python
import csv

with open('reader.txt') as open_file:
    # Установим параметр quoting=csv.QUOTE_NONE и запретим использование кавычек для обособления элементов.
    read_file = csv.reader(open_file, delimiter=';', quoting=csv.QUOTE_NONE)
    for row in read_file:
        print(row)
```

_Получим результат_:
```
['Заголовок', 'первая строка']
['Вторая строка', '"текст', 'цифры"']
["'Третья строка", 'текст', "цифры'"]
```
- *В данном примере отработал только разделитель, все кавычки проигнорированны.*

### - Примеры. Блок 3. (Запись в  файл с дополнительными параметрами.)

### пример использования `newline=`

> `newline=` - параметр позволяет убрать пустые строки, когда мы записываем данные в файл.

**Рассмотрим два способа записи данных в файл:**

Вариант 1. 
* Используем вложенную конструкцию with. 
* Открываем два файла (для четиния и для записи). 
* Читаем данные из первого файла построчно и сразу записываем во второй файл. 

**Исходный файл `reader.txt`**
```
Заголовок,первая строка
Вторая строка,текст,цифры
Третья строка,"единые,данные"
```

**Выполним код:**
```python
import csv

with open('reader.txt') as open_file:
    read_file = csv.reader(open_file)
    with open('writer.txt', 'w', newline='') as new_file:
        write_file = csv.writer(new_file)
        for row in read_file:
            write_file.writerow(row)
```

_Получим результат в файле `writer.txt`_:
```
Заголовок,первая строка
Вторая строка,текст,цифры
Третья строка,"единые,данные"
```

Вариант 2.
* Используем два блока with
* Прочитаем файл в список
* Запишем данные из списка в новый файл.

**Исходный файл `reader.txt`**
```
Заголовок,первая строка
Вторая строка,текст,цифры
Третья строка,"единые,данные"
```

**Выполним код:**
```python
import csv

with open('reader.txt') as open_file:
    read_file = csv.reader(open_file)
    read_data = list(read_file)
    first_str = read_data[0]
    other_str = read_data[1:]

with open('writer.txt', 'w', newline='') as new_file:
    write_file = csv.writer(new_file)
    write_file.writerow(first_str)
    write_file.writerows(other_str)
```

_Получим аналогичный "Варианту 1" результат в файле `writer.txt`_:
```
Заголовок,первая строка
Вторая строка,текст,цифры
Третья строка,"единые,данные"
```

### пример использования `delimiter=`

**Исходный файл `reader.txt`**
```
Заголовок,первая строка
Вторая строка,текст,цифры
Третья строка,"единые,данные"
```

**Выполним код:**
```python
import csv

with open('reader.txt') as open_file:
    read_file = csv.reader(open_file)
    with open('writer.txt', 'w', newline='') as new_file:
        write_file = csv.writer(new_file, delimiter=';')
        for row in read_file:
            write_file.writerow(row)
```

_Получим результат в файле `writer.txt`_:
```
Заголовок;первая строка
Вторая строка;текст;цифры
Третья строка;единые,данные
```

* Разделитель изменен с запятой (по умолчанию) на точку с запятой.
* Во время записи данных в файл Python убрал кавычки, так как конфликта между запятой -разделителем и запятой как части данных нет.

### пример использования `quotechar=`

**Исходный файл `reader.txt`**
```
Заголовок,первая строка
Вторая строка,текст,цифры
Третья строка,"единые,данные"
```

**Выполним код:**
```python
import csv

with open('reader.txt') as open_file:
    read_file = csv.reader(open_file)
    with open('writer.txt', 'w', newline='') as new_file:
        write_file = csv.writer(new_file, quotechar='*')
        for row in read_file:
            write_file.writerow(row)
```

_Получим результат в файле `writer.txt`_:
```
Заголовок,первая строка
Вторая строка,текст,цифры
Третья строка,*единые,данные*
```

* Заменили двойные кавычки (символ по умолчанию для выделения данных в единый элемент) на символ звездочки *. 

### пример использования `quoting=csv.QUOTE_NONE`, `escapechar='\\'`

**Исходный файл `reader.txt`**
```
Заголовок,первая строка
Вторая строка,текст,цифры
Третья строка,"единые,данные"
```

**Выполним код:**
```python
import csv

with open('reader.txt') as open_file:
    read_file = csv.reader(open_file)
    with open('writer.txt', 'w', newline='') as new_file:
        write_file = csv.writer(new_file, quoting=csv.QUOTE_NONE, escapechar='\\')
        for row in read_file:
            write_file.writerow(row)
```

_Получим результат в файле `writer.txt`_:
```
Заголовок,первая строка
Вторая строка,текст,цифры
Третья строка,единые\,данные
```
* Запретили использование кавычке параметром **uoting=csv.QUOTE_NONE**
* Выполнили экранирование проблемного символа при помощи **escapechar='\\'** (в нашем случае запятой, которая не является разделителем, а является элементом строки данных).

### пример использования `csv.register_dialect()`

Повторим все действия с данными из примера выше, только при помощи шаблона настроек записи в файл `csv.register_dialect()`

**Исходный файл `reader.txt`**
```
Заголовок,первая строка
Вторая строка,текст,цифры
Третья строка,"единые,данные"
```

**Немного изменим и выполним код:**
```python
import csv

csv.register_dialect('custom', quoting=csv.QUOTE_NONE, escapechar='\\') #создаем шаблон настроек и присваиваем ему имя.

with open('reader.txt') as open_file:
    read_file = csv.reader(open_file)
    with open('writer.txt', 'w', newline='') as new_file:
        write_file = csv.writer(new_file, 'custom') #укащываем шаблон с настройками, которые хотим применить при записи.
        for row in read_file:
            write_file.writerow(row)
```

_Получим такой же рузультат результат как и в прошлом примере в файле `writer.txt`_:
```
Заголовок,первая строка
Вторая строка,текст,цифры
Третья строка,единые\,данные
```
* Данных подход позволяет заранее подготавливать шаблоны с разными настройками, что значительно ускоряет работу с файлами.
