*Последние изменения внесены 22.04.2023*

# SQL - Structured Query Language

**SQL** — это язык структурированных запросов. Данный язык понимает СУБД, которая и производит операции с данными.

## Типы запросов в SQL
* **DDL** (Data Definition Language) - `CREATE`, `ALTER`, `DROP` (управление таблицами)
* **DML** (Data Manipulation Language) - `SELECT`, `INSERT`, `UPDATE`, `DELETE` (управление данными внутри таблицы)
* **TCL** (Transaction Control Language) - `COMMIT`, `ROLLBACK`, `SAVEPOINT` (управление транзакциями)
* **DCL** (Data Control Language) - `GRANT`, `REVOKE`, `DENY` (управление пользователями и их правами)

# Data Manipulation Language

## 1.1 `INSERT INTO` - добавление данных. 

**Для добавления данных применяется команда `INSERT`, которая имеет следующий формальный синтаксис:**
```mysql
INSERT INTO имя_таблицы (столбец1, столбец2, ... столбецN) 
VALUES (значение1, значение2, ... значениеN)
```

* После `INSERT INTO` идет имя таблицы, затем в скобках указываются все столбцы через запятую, в которые надо добавлять данные. И в конце после слова VALUES в скобках перечисляются добавляемые значения.

### Рассмотрим возможные синтаксические конструкции запроса INSERT INTO.
### `Вариант 1.`

**Допустим, у нас в базе данных есть следующая талица:**
```sql
CREATE TABLE Products
(
    Id SERIAL PRIMARY KEY,
    ProductName VARCHAR(30) NOT NULL,
    Manufacturer VARCHAR(20) NOT NULL,
    ProductCount INTEGER DEFAULT 0,
    Price NUMERIC
);
```
**Добавим в нее одну строку с помощью команды `INSERT`:**

```sql
INSERT INTO Products VALUES (1, 'Galaxy S9', 'Samsung', 4, 63000)
```

* Стоит учитывать, что значения для столбцов в скобках после ключевого слова `VALUES` передаются **!!! по порядку их объявления !!!**. 
* Например, в выражении `CREATE TABLE` выше можно увидеть, что первым столбцом идет **Id**, поэтому этому столбцу передаетсячисло 1. 
* Второй столбец называется **ProductName**, поэтому второе значение - строка **"Galaxy S9"** будет передано именно этому столбцу и так далее. 
* То есть значения передаются столбцам следующим образом:
    1) **Id**: 1

    2) **ProductName**: 'Galaxy S9'

    3) **Manufacturer**: 'Samsung'

    4) **ProductCount**: 4

    5) **Price**: 63000

### `Вариант 2.`

**При вводе значений можно указать непосредственные столбцы, в которые будут добавляться значения:**

```sql
INSERT INTO Products (ProductName, Price, Manufacturer) 
VALUES ('iPhone X', 71000, 'Apple');
```

* Здесь значение указывается только для трех столбцов. 
* Причем теперь значения передаются в порядке следования столбцов в запросе, а не в порядке расположения их в таблице БД:

    1) **ProductName**: 'iPhone X'

    2) **Manufacturer**: 'Apple'

    3) **Price**: 71000


* Для столбца **Id** значение будет генерироваться автоматически базой данных, так как он представляет тип `Serial`. 
* То есть к значению из последней строки будет добавляться единица.
* Для остальных столбцов будет добавляться значение по умолчанию, если задан атрибут `DEFAULT` (например, для столбца **ProductCount**), значение `NULL`. 
* При этом неуказанные столбцы (за исключением тех, которые имеют тип `Serial`) должны допускать значение `NULL` или иметь атрибут `DEFAULT`.

### !!! Если конкретные столбцы не указываются, как в первом примере, тогда мы должны передать значения для всех столбцов в таблице. !!!

### `Вариант 3`

**Также мы можем добавить сразу несколько строк:**

```sql
INSERT INTO Products  (ProductName, Manufacturer, ProductCount, Price)
VALUES
('iPhone 6', 'Apple', 3, 36000),
('Galaxy S8', 'Samsung', 2, 46000),
('Galaxy S8 Plus', 'Samsung', 1, 56000)
```

* В данном случае в таблицу будут добавлены три строки.

### `RETURNING` - Возвращение значений.

* Если мы добавляем значения только для части столбцов, то мы можем не знать, какие значения будут у других столбцов. * Например, какое значени получит столбец **Id** у товара. 
* С помощью оператора `RETURNING` мы можем получить это значение:

```sql
INSERT INTO Products 
(ProductName, Manufacturer, ProductCount, Price) 
VALUES('Desire 12', 'HTC', 8, 21000) RETURNING id;
```

* В результате выполнения запроса из примера мы получит **id** добавленной записи.

## 1.2 `SELECT` - получение данных.

**Для извлечения данных из БД применяется команда `SELECT`. В упрощенном виде она имеет следующий синтаксис:**

```sql
SELECT список_столбцов FROM имя_таблицы
```

**Например, пусть ранее была создана таблица Products, и в нее добавлены некоторые начальные данные:**

```sql
CREATE TABLE Products
(
    Id SERIAL PRIMARY KEY,
    ProductName VARCHAR(30) NOT NULL,
    Manufacturer VARCHAR(20) NOT NULL,
    ProductCount INTEGER DEFAULT 0,
    Price NUMERIC
);
 
INSERT INTO Products (ProductName, Manufacturer, ProductCount, Price)
VALUES
('iPhone X', 'Apple', 3, 36000),
('iPhone 8', 'Apple', 2, 41000),
('Galaxy S9', 'Samsung', 2, 46000),
('Galaxy S8 Plus', 'Samsung', 1, 56000),
('Desire 12', 'HTC', 5, 28000);
```

**Получим все объекты из этой таблицы:**

```sql
SELECT * FROM Products;
```

* Символ звездочка `*` указывает, что нам надо получить все столбцы.
* Однако использование символа звездочки `*` считается не очень хорошей практикой, так как, как правило, не все столбцы бывают нужны. 
* И более оптимальный подход заключается в указании всех необходимых столбцов после слова `SELECT`.
* Исключение составляет тот случай, когда надо получить данные по абсолютно всем столбцам таблицы. 
* Также использование символа `*` может быть предпочтительно в таких ситуациях, когда в точности не известны названия столбцов.

**Если нам надо получить данные не по всем, а по каким-то конкретным столбцам, то тогда все эти спецификации столбцов перечисляются через запятую после `SELECT`:***

```sql
SELECT ProductName, Price FROM Products;
```

**Спецификация столбца необязательно должна представлять его название. Это может быть любое выражение, например, результат арифметической операции. 
Так, выполним следующий запрос:**

```sql
SELECT ProductCount, Manufacturer, Price * ProductCount
FROM Products;
```

* Здесь при выборке будут создаваться три столбца. 
* Причем третий столбец представляет значение столбца **Price**, умноженное на значение столбца **ProductCount**, то есть совокупную стоимость товара.

### Оператор `AS`
**С помощью оператора AS можно изменить название выходного столбца или определить его псевдоним:**

```sql
SELECT 
    ProductCount AS Title, 
    Manufacturer, 
    Price * ProductCount  AS TotalSum
FROM Products;
```
* В данном случае результатом выборки являются данные по 3-м столбцам. 
* Для вывода первого столбца определяется псевдоним **Title**, хотя в реальности он будет представлять столбец **ProductName**. 
* Второй столбец сохраняет свое название - **Manufacturer**. 
* Третий столбец **TotalSum** хранит произведение столбцов **ProductCount** и **Price**.

## 1.3 `WHERE` - фильтрация. 

**Для фильтрации данных применяется оператор WHERE, после которого указывается условие, на основании которого производится фильтрация:**

```sql
WHERE условие
```

### `Операторы сравнения`

* Если условие истинно, то строка попадает в результирующую выборку. 
* В качестве можно использовать **операции сравнения**. 
* Эти операции сравнивают два выражения. 
* В **PostgreSQL** можно применять следующие операции сравнения:

`=` сравнение на равенство

`<>` сравнение на неравенство

`<` меньше чем

`>` больше чем

`!<` не меньше чем

`!>` не больше чем

`<=` меньше чем или равно

`>=` больше чем или равно

**Например, найдем всех товары, производителем которых является компания Apple:**

```sql
SELECT * FROM Products
WHERE Manufacturer = 'Apple';
```
* Стоит отметить, что в данном случае большое значение имеет регистр символов, к примеру, строка **"Apple"** не эквивалентна строке **"APPLE"** или **"apple"**.

**Другой пример - найдем все товары, у которых цена меньше 29000:**

```sql
SELECT * FROM Products
WHERE Price < 39000;
```

**В качестве условия могут использоваться и более сложные выражения. Например, найдем все товары, у которых совокупная стоимость больше 90 000:**

```sql
SELECT * FROM Products
WHERE Price * ProductCount > 90000;
```

### `Логические операторы`

**Чтобы объединить нескольких условий в одно, в PostgreSQL можно использовать логические операторы:**

**`AND` операция логического И. Она объединяет два выражения:**

```sql
выражение1 AND выражение2
```

* Только если оба этих выражения одновременно истинны, то и общее условие оператора `AND` также будет истинно. 
* То есть если и первое условие истинно, и второе.

**`OR` операция логического ИЛИ. Она также объединяет два выражения:**

```sql
выражение1 OR выражение2
```

* Если хотя бы одно из этих выражений истинно, то общее условие оператора `OR` также будет истинно. 
* То есть если или первое условие истинно, или второе.

**`NOT` операция логического отрицания. Если выражение в этой операции ложно, то общее условие истинно.**

```sql
NOT выражение
```

**Например, выберем все товары, у которых производитель Samsung и одновременно цена больше 50000:**

```sql
SELECT * FROM Products
WHERE Manufacturer = 'Samsung' AND Price > 50000;
```

**Теперь изменим оператор на `OR`. То есть выберем все товары, у которых либо производитель Samsung, либо цена больше 50000:**

```sql
SELECT * FROM Products
WHERE Manufacturer = 'Samsung' OR Price > 50000;
```

**Применение оператора `NOT` - выберем все товары, у которых производитель не Samsung:**

```sql
SELECT * FROM Products
WHERE NOT Manufacturer = 'Samsung';
```

* Но в большинстве случае вполне можно обойтись без оператора `NOT`. 
* Так, в предыдущий пример мы можем переписать следующим образом:

```sql
SELECT * FROM Products
WHERE Manufacturer <> 'Samsung'
```

**Также в одной команде `SELECT` можно использовать сразу несколько операторов:**

```sql
SELECT * FROM Products
WHERE Manufacturer = 'Samsung' OR Price > 30000 AND ProductCount > 2;
```

* Так как оператор `AND` **!!! имеет более высокий приоритет !!!**, то сначала будет выполняться подвыражение **Price > 30000 AND ProductCount > 2**, и только потом оператор `OR`. 
* То есть здесь выбираются товары, которыех на складе больше 2 и у которых одновременно цена больше 30000, либо те товары, производителем которых является **Samsung.**

**С помощью скобок мы также можем переопределить порядок операций:**

```sql
SELECT * FROM Products
WHERE (Manufacturer = 'Samsung' OR Price > 30000) AND ProductCount > 2;
```

### `IS NULL`  и `IS NOT NULL`

* Ряд столбцов может допускать значение `NULL`. 
* Это значение не эквивалентно пустой строке `''`. 
* `NULL` представляет полное отсутствие какого-либо значения. 
* И для проверки на наличие подобного значения применяется оператор `IS NULL`.

**Например, выберем все товары, у которых не установлено поле ProductCount:**

```sql
SELECT * FROM Products
WHERE ProductCount IS NULL;
```

**Если, наоборот, необходимо получить строки, у которых поле ProductCount не равно `NULL`, то можно использовать оператор `NOT`:**

```sql
SELECT * FROM Products
WHERE ProductCount IS NOT NULL;
```

## 1.4 `UPDATE` - обновление данных.

* Для обновления данных в базе данных **PostgreSQL** применяется команда `UPDATE`. 
* Она имеет следующий общий формальный синтаксис:

```sql
UPDATE 
    имя_таблицы
SET 
    столбец1 = значение1, 
    столбец2 = значение2, 
    ... 
    столбецN = значениеN 
WHERE 
    условие_обновления
```
**Например, увеличим у всех товаров цену на 3000:**

```sql
UPDATE Products
SET Price = Price + 3000;
```
* В данном случае обновление касается всех строк.

* С помощью выражения `WHERE` можно с помощью условию конкретизировать обновляемые строки - если строка соответствует условию, то она будет обновляться. 
* Например, изменим название производителя с "Samsung" на "Samsung Inc.":

```sql
UPDATE 
    Products
SET 
    Manufacturer = 'Samsung Inc.'
WHERE 
    Manufacturer = 'Samsung';
```

**Также можно обновлять сразу несколько столбцов:**

```sql
UPDATE 
    Products
SET 
    Manufacturer = 'Samsung',
    ProductCount = ProductCount + 3
WHERE 
    Manufacturer = 'Samsung Inc.';
```

## 1.5 `DELETE FROM` - удаление данных.

* Для удаления данных в **PostgreSQL** применяется команда `DELETE`. 
* Она имеет следующий синтаксис:

```sql
DELETE FROM 
    имя_таблицы
WHERE 
    условие_удаления
```

**Например, удалим строки, у которых производитель - Apple:**

```sql
DELETE FROM 
    Products
WHERE 
    Manufacturer='Apple';
```

**Или удалим все товары, производителем которых является HTC и которые имеют цену меньше 35000:**

```sql
DELETE FROM 
    Products
WHERE 
    Manufacturer='HTC' AND Price < 15000;
```

**Если необходимо вовсе удалить все строки вне зависимости от условия, то условие можно не указывать:**

```sql
DELETE FROM Products;
```


```python

```
